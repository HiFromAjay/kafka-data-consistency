<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Milk Factory</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"></script>
    <script src="https://unpkg.com/vue@next"></script>
    <link href="https://unpkg.com/primevue/resources/themes/saga-blue/theme.css " rel="stylesheet">
    <link href="https://unpkg.com/primevue/resources/primevue.min.css " rel="stylesheet">
    <link href="https://unpkg.com/primeicons/primeicons.css " rel="stylesheet">
    <script src="https://unpkg.com/primevue/components/calendar/calendar.umd.min.js"></script>
    <script src="https://unpkg.com/primevue/components/dropdown/dropdown.umd.min.js"></script>
    <script>
// cases each quarkus uService to reload, since it doesnt do that when a kafka event arrives
const CONTRACTS_BASE_URL = "http://localhost:8080"; // http://178.199.206.170
const PRICING_BASE_URL   = "http://localhost:8081";
const WEB_BASE_URL       = "http://localhost:8082";
const PARTNERS_BASE_URL  = "http://localhost:8083";
const CASES_BASE_URL     = "http://localhost:8084";

function pingAll() {
    fetch(CONTRACTS_BASE_URL + "/ping").then(r => r.text());
    fetch(PRICING_BASE_URL   + "/ping").then(r => r.text());
    fetch(WEB_BASE_URL       + "/ping").then(r => r.text());
    fetch(PARTNERS_BASE_URL  + "/ping").then(r => r.text());
    fetch(CASES_BASE_URL     + "/ping").then(r => r.text());
}
    </script>
    <style>
    /* TODO make the cursor work - conflict with primevue */
    .p-disabled {
        cursor: wait !important;
        background-color: grey;
    }
    </style>
</head>
<body style="background-image: url(https://hips.hearstapps.com/del.h-cdn.co/assets/15/24/1600x800/landscape-1433889344-del-milkshakes-index.jpg); background-color: rgba(255, 255, 255, 0.85); background-blend-mode: overlay;">
    <h2>The Milk Factory</h2>
    <div id="app">
        <div style="width: 100%; text-align: right; font-size: small;">
            <button onclick="pingAll()">reload all microservices</button><br>
            Force error: <p-dropdown :options="forcibleErrors" v-model="forceError">
                            <template #option="slotProps">{{slotProps.option.label}}</template>
                            <template #value="slotProps">{{slotProps.value.label}}</template>
                        </p-dropdown>
        </div>
        <div>
            <p-calendar v-model="model.startDate" :showIcon="true" placeholder="Select a date for your order"></p-calendar>
            <button @click="newDraft()">get new draft</button>
        </div>
        <div style="font-size: small;">
            Drafted in {{ timeTaken }}ms
        </div>
        <div v-if="get(model, 'draft.contract')">
            Contract ID: {{ model.draft.contract.id }}
        </div>
        <div v-if="!!get(model, 'draft.pack.price')">
            Product: {{ model.draft.pack.children[0].productId }} {{ model.draft.pack.price.total }} CHF ({{ model.draft.pack.price.tax }} CHF VAT)
        </div>
        <div v-if="!!get(model, 'draft.pack.price')">
            <ul>
                <li v-for="child in model.draft.pack.children">
                    {{ child.componentDefinitionId }}: {{ child.price.total }} CHF
                    <ul v-if="get(child, 'children.length') > 0">
                        <li v-for="child2 in child.children">
                            {{ child2.componentDefinitionId }}: {{ child2.price.total }} CHF
                            <div v-if="child2.configPossibilities && child2.configPossibilities.length > 0">
                                <div v-for="paramName in getDistinctParamNames(child2.configPossibilities)">
                                    {{paramName}}: <p-dropdown :options="getParamOptions(paramName, child2)"
                                                               v-model="child2.$configs[paramName].value"
                                                               @change="changeParam(child2, paramName, $event)"
                                                               :disabled="child2.$configs[paramName].waiting"
                                                    ></p-dropdown>
                                </div>
                            </div>
                            <ul v-if="get(child2, 'children.length') > 0">
                                <li v-for="child3 in child2.children">
                                    {{ child3.componentDefinitionId }}: {{ child3.price.total }} CHF
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        </div>
    </div>
    <hr>
</body>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
// https://stackoverflow.com/a/2117523/458370
function uuidv4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}

const forcibleErrors = [ {label: 'none', value: 'none'},
                        {label: 'business error in contracts', value: 'businessErrorInContracts'},
                        {label: 'technical error in contracts', value: 'technicalErrorInContracts'},
                        {label: 'business error in pricing', value: 'businessErrorInPricing'},
                        {label: 'technical error in pricing', value: 'technicalErrorInPricing'} ];
const App = {
  data() {
    return {
      model: {"draft": {"contract": {}, "pack": {}, "prices": {}}, "startDate": new Date()},
      start: 0,
      timeTaken: 0,
      source: null,
      currentAction: null,
      requestId: uuidv4(),
      forcibleErrors,
      forceError: forcibleErrors[0],
    }
  },
  mounted() {
    this.newDraft();
    window.model = this.model;
  },
  methods: {
    newDraft() {
        this.start = new Date().getTime();
        let body = {
          "productId": "COOKIES_MILKSHAKE",
          "start": new Date(new Date().getTime() + 24*3600000).toISOString().substr(0,10)
        }
        this.currentAction = {action: "newDraft"}

        // subscribe before sending request to server, to ensure we receive ALL of the events, and any errors
        sse(this.requestId, this);

        fetch(CONTRACTS_BASE_URL + "/drafts",
              { "method": "POST",
                body: JSON.stringify(body),
                "headers": getHeaders(this.getDemoContext)
              }
        )
        .then(r => r.json())
        .then(r => {
            console.log("got contract with id " + r.id + ", for requestId " + this.requestId);
        });
    },
    get(obj, path) {
        // vue3 doesnt like seeing underscores in attribute values => so lets create an alias with this method
        return _.get(obj, path);
    },
    getDistinctParamNames(configPossibilities) {
        return _(configPossibilities).map("name").uniq().value()
    },
    getParamOptions(paramName, component) {
        let vals = _(component.configPossibilities)
                    .filter(c => c.name === paramName)
                    .map("value")
                    .value()
        return vals;
    },
    changeParam(component, paramName, e) {
        let newValue = component.$configs[paramName].value
        let oldValue = _(component.configs).find(c => c.name === paramName).value
        if(newValue != oldValue) {
            component.$configs[paramName].waiting = true // causes disabled
            console.log("change param " + paramName + " on component " + component.componentId + " to " + newValue)
            this.currentAction = {action: "changeParam", paramName, componentId: component.componentId, oldValue, newValue}
            let self = this;
            this.start = new Date().getTime();
            fetch(CONTRACTS_BASE_URL + "/drafts/" + this.model.draft.contract.id + "/" + component.componentId + "/" + paramName + "/" + newValue,
                  { "method": "PUT",
                    "headers": getHeaders(this.getDemoContext)
                  }
            )
            .then(r => {
                return r.json().then(payload => ({payload, ok: r.ok}))
            }).then(r => {
                if(r.ok) console.log("updated contract with id " + r.payload.id + ", for requestId " + self.requestId);
                else throw Error(r.payload)
            }).catch(error => {
                console.error("received error: " + error);
                alert("an error occurred - see the console");
                ameliorateCurrentAction(self)
            });
        }
    },
    getDemoContext() {
        return JSON.stringify( { forceError: this.forceError.value } )
    }
  },
  components: {
    'p-calendar': calendar,
    'p-dropdown': dropdown
  }
}
Vue.createApp(App).mount("#app")

function addPrice(component, id, price) {
    if(component.componentId == id) {
        component.price = price
    } else {
        _.forEach(component.children, child => addPrice(child, id, price))
    }
}

function getHeaders(getDemoContext) {
    return {"Content-Type": "application/json", "request-id": this.requestId, "demo-context": getDemoContext() }
}

function sse(requestId, self) {
    if(self.source && self.source.readyState != EventSource.CLOSED) self.source.close();
    self.source = new EventSource("/web/stream/" + requestId);
    self.source.onmessage = function (event) {
        console.log(event);
        let msg = JSON.parse(event.data);
        if(msg.event == "CREATED_DRAFT") {
            self.model.draft = msg.payload;
            initialiseDraft(self.model.draft.pack);
        } else if(msg.event == "UPDATED_DRAFT") {
            updateDraft(msg.payload.allComponents, self.model.draft.pack);
        } else if(msg.event == "UPDATED_PRICES") {
            self.model.draft.prices = msg.payload.priceByComponentId;
            _.forEach(self.model.draft.prices, (v,k) => {
                addPrice(self.model.draft.pack, k, v);
            });
            self.timeTaken = new Date().getTime() - self.start;
        } else if(msg.event == "CHANGED_CASE") {
            if(msg.originalCommand == "CREATE_TASK" || msg.originalCommand == "UPDATE_TASK") {
                // TODO refresh area that show tasks related to this sales case
            }
        } else if(msg.event == "ERROR") {
            console.error("received error: " + JSON.stringify(msg));
            alert("an error occurred - see the console");
            ameliorateCurrentAction(self)
        } else {
            console.error("received unexpected event: " + event.data);
        }
    };
    self.source.onerror = function (event) {
        console.log("sse error " + event);
        if(self.source && self.source.readyState != EventSource.CLOSED) self.source.close();
        self.source = null;
    }
}

function ameliorateCurrentAction(self) {
    if(self.currentAction.action == "newDraft") {
        // not much can be done => user has a button to go get a new one
    } else if(self.currentAction.action == "changeParam") {
        alert("TODO offer user the chance to reload the entire draft with the backend state");
        // {action: "changeParam", paramName, componentId, oldValue, newValue}
        removeWaitingAndResetValue(self.currentAction.componentId, self.currentAction.paramName, self.currentAction.oldValue, self.model.draft.pack)
    } else {
        console.error("unexpected current action: " + self.currentaction.action)
    }
}

function removeWaitingAndResetValue(targetComponentId, paramName, oldValue, component) {
    if(component.componentId == targetComponentId) {
        component.$configs[paramName].waiting = false
        component.$configs[paramName].value = oldValue
    }
    _.forEach(component.children, child => removeWaitingAndResetValue(targetComponentId, paramName, oldValue, child));
}

function initialiseDraft(component) {
    component.$configs = {}
    _.forEach(component.configs, c => component.$configs[c.name] = _.clone(c));
    _.forEach(component.children, child => initialiseDraft(child));
}

function updateDraft(newComponents, component){
    let newComponent = _(newComponents).find(c => c.id === component.componentId)
    if(newComponent) {
        component.configs = newComponent.configs; // adopt new configs
        _.forEach(component.configs, c => component.$configs[c.name] = _.clone(c)); // also clears waiting (disabled)
    } else {
        console.error("no component with ID " + component.componentId + " found in response")
    }

    _.forEach(component.children, child => updateDraft(newComponents, child));
}

</script>
</html>
