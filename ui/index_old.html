<!DOCTYPE html>
<html>
<head>
    <title>Start Page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="./code.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.core.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
</head>
<body>
<table width="100%" height="100%">
    <tr>
        <td colspan="2" align="center">
            <h2><img height="50px" src="k.jpg" style="vertical-align: text-bottom;">AYS Insurance Ltd.</h2>
        </td>
        <td align="right" valign="top">
            <small><a href="#" onclick="clearData();">clear test data</a></small>
        </td>
    </tr>
    <tr><td colspan="3">
        <hr>
    </td></tr>
    <tr>
        <td width="20%" valign="top">
            <div id="menu"><i class="fas fa-ellipsis-v"></i>&nbsp;Menu</div>
        </td>
        <td width="60%" valign="top">
            <div id="partner" class="tile-group">
                <table>
                    <tr><td class='tile'>
                        <div class='tile-title'><i class="fas fa-user"></i>&nbsp;<b>Ant Kutschera</b></div>
                        <div class='tile-body'>
                            C-4837-4536<br>
                            Ch. des chiens 69<br>
                            1000 Marbach<br>
                            +41 77 888 99 00<br>
                        </div>
                        <td></tr>
                </table>
            </div>
            <hr>
            <div id="contracts" class="tile-group">
                <table>
                    <tr><td class='tile'>
                        <div class='tile-title'><i class="fas fa-file-contract"></i>&nbsp;<b>V-9087-4321</b></div>
                        <div class='tile-body'>
                            House contents insurance<br>
                            incl. fire and theft
                        </div>
                    <td></tr>
                </table>
            </div>
            <hr>
            <div id="claims" class="tile-group">claims</div>
            <br>
            <button onclick="createClaim();">Create new claim...</button>
        </td>
        <td width="20%" valign="top">
            <div id="tasks" class="tile-group">tasks</div>
            <hr>
            <div id="documents" class="tile-group">
                <table>
                    <tr><td class='tile'>
                        <div class='tile-title'><i class="far fa-file-alt"></i>&nbsp;<b>D-5843-79684</b></div>
                        <div class='tile-body'>
                            Contract Document<br>
                            2018-08-01
                        </div>
                    <td></tr>
                </table>
            </div>
        </td>
    </tr>
</table>
<script>
function loadClaims() {
    document.getElementById("claims").innerHTML = "loading...";
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'http://localhost:8081/claims/rest/claims', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                var claims = JSON.parse(xhr.responseText);
                var html = "<table>";
                if(claims.length === 0) {
                    html = "<i>No claims</i>";
                } else {
                    _.forEach(claims, function(c){
                        html += "<tr><td class='tile'>" +
                                    "<div class='tile-title'><i class='fas fa-exclamation-circle'></i>&nbsp;Claim</div>" +
                                    "<div class='tile-body'><i>" + c.id + "</i><br>" + c.description + "</div>" +
                                    "<td></tr>";
                    });
                    html += "<table>";
                }
                document.getElementById("claims").innerHTML = html;
            } else {
                alert("failed to get claims: " + xhr.status + "::" + xhr.responseText);
            }
        }
    }
    xhr.send();
}

function createClaim() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://localhost:8081/claims/rest/claims', true);
    xhr.setRequestHeader("Content-type", "application/json");
    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status === 202) {
                console.log("claim creation request accepted");
            } else {
                alert("failed to create claim: " + xhr.status + "::" + xhr.responseText);
            }
        }
    }
    xhr.send(JSON.stringify({"description" :"Nunc dictum tristique ex eu eleifend. Ut non massa ut libero imperdiet sollicitudin.", "customerId": "C-4837-4536"}));
}

function clearData() {
    var xhr = new XMLHttpRequest();
    xhr.open('DELETE', 'http://localhost:8081/claims/rest/claims', true);
    xhr.send();

    xhr = new XMLHttpRequest();
    xhr.open('DELETE', 'http://localhost:8082/tasks/rest/tasks', true);
    xhr.send();
}

function loadTasks() {
    document.getElementById("tasks").innerHTML = "loading...";
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'http://localhost:8082/tasks/rest/tasks', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                var tasks = JSON.parse(xhr.responseText);
                var html = "<table>";
                if(tasks.length === 0) {
                    html = "<i>No tasks</i>";
                } else {
                    _.forEach(tasks, function(t){
                        html += "<tr><td class='tile'>" +
                                    "<div class='tile-title'><i class='fas fa-tasks'></i>&nbsp;Task</div>" +
                                    "<div class='tile-body'>" + t + "</div>" +
                                    "<td></tr>";
                    });
                    html += "<table>";
                }
                document.getElementById("tasks").innerHTML = html;
            } else {
                alert("failed to load tasks: " + xhr.status + "::" + xhr.responseText);
            }
        }
    }
    xhr.send();
}

window.onWSMessage = function(data) {
    if(data.topic === "task-created-event") {
        loadTasks();
    } else if(data.topic === "claim-created-event") {
        loadClaims();
    } else {
        console.error("unknown event received: " + JSON.stringify(data));
    }
}

loadClaims();
loadTasks();
</script>

</body>
</html>